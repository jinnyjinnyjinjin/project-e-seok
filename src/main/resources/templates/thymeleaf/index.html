<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>오구대대구장</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="/plugins/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" href="/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="/dist/css/expense/expense.css">
    <!-- Datatables -->
    <link rel="stylesheet" href="/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Popperjs -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
            crossorigin="anonymous"></script>
    <!-- Tempus Dominus JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.7.11/dist/js/tempus-dominus.min.js"
            crossorigin="anonymous"></script>
    <!-- Tempus Dominus Styles -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.7.11/dist/css/tempus-dominus.min.css"
          crossorigin="anonymous">

</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/index" class="nav-link">Home</a>
            </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">

        </ul>
    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="/index" class="brand-link">
            <img src="/dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
                 style="opacity: .8">
            <span class="brand-text font-weight-light">오구대대구장</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Sidebar user panel (optional) -->
            <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                <div class="image">
                    <img src="/dist/img/user2-160x160.jpg" class="img-circle elevation-2" alt="User Image">
                </div>
                <div class="info">
                    <a href="#" class="d-block">채이석 사장님</a>
                </div>
            </div>

            <!-- Sidebar Menu -->
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
                    data-accordion="false">
                    <li class="nav-item">

                    </li>
                </ul>
            </nav>
            <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper" style="min-height: 2013.06px;">

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <h2 class="col-12 text-center display-4">지출 내역</h2>
                </div>
                <div class="row">
                    <div class="col"></div>
                    <div class="col-6">
                        <div class="btn-group col" role="group" aria-label="Expense Button">
                            <button type="button" class="btn btn-lg btn-danger" data-toggle="modal"
                                    data-target="#minusFormModal">
                                <i class="fa fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-lg btn-info" data-toggle="modal"
                                    data-target="#incomeFormModal">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col"></div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="card" style="margin-top: 100px">
                            <div class="card-body">
                                <div id="example2_wrapper" class="dataTables_wrapper dt-bootstrap4">
                                    <div id="expensedToday" class="row">
                                        <div class="col">
                                            <div class="card">
                                                <div class="card-body">
                                                    <span style="font-weight: bold">총 지출&nbsp;&nbsp;<span
                                                            id="totalExpense"></span> 원</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="incomeToday" class="row">
                                        <div class="col">
                                            <div class="card">
                                                <div class="card-body">
                                                    <span style="font-weight: bold">총 수입&nbsp;&nbsp;<span
                                                            id="totalIncome"></span> 원</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row" style="margin-top: 50px">
                                        <div class="col-sm-12 col-md-6">
                                            <div class="form-group">
                                                <label>검색 기간</label>
                                                <div class="input-group">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text">
                                                        <i class="far fa-calendar-alt"></i>
                                                        </span>
                                                    </div>
                                                    <input type="text" class="form-control daterange-format float-right"
                                                           id="expensePeriod"/>
                                                    <div class="input-group-append">
                                                        <button class="input-group-text" id="searchItem">
                                                            <i class="fas fa-search"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-12 col-md-6">
                                            <!--                                            <div class="form-group">-->
                                            <!--                                                <label>검색</label>-->
                                            <!--                                                <div id="example1_filter" class="dataTables_filter">-->
                                            <!--                                                    <div class="input-group">-->
                                            <!--                                                        <input id="searchItem" type="search" class="form-control float-right"-->
                                            <!--                                                               placeholder="" aria-controls="example1">-->
                                            <!--                                                        <div class="input-group-append">-->
                                            <!--                                                        <button class="input-group-text" id="search">-->
                                            <!--                                                            <i class="fas fa-search"></i>-->
                                            <!--                                                        </button>-->
                                            <!--                                                        </div>-->
                                            <!--                                                    </div>-->
                                            <!--                                                </div>-->
                                            <!--                                            </div>-->
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12 col-md-6"></div>
                                        <div class="col-sm-12 col-md-6"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <table id="expenseTable"
                                                   class="table table-bordered table-hover dataTable dtr-inline"
                                                   aria-describedby="example2_info">
                                                <thead>
                                                <tr>
                                                    <th class="sorting sorting_desc" tabindex="0"
                                                        aria-controls="expenseTable" rowspan="1" colspan="1"
                                                        aria-sort="descending"
                                                        aria-label="Rendering engine: activate to sort column descending">
                                                        no.
                                                    </th>
                                                    <th class="sorting" tabindex="1" aria-controls="expenseTable"
                                                        rowspan="1" colspan="1"
                                                        aria-label="일시: 지출한 일시">
                                                        일시
                                                    </th>
                                                    <th class="sorting" tabindex="2" aria-controls="expenseTable"
                                                        rowspan="1" colspan="1"
                                                        aria-label="사용처: 지출 내용">
                                                        사용처
                                                    </th>
                                                    <th class="sorting" tabindex="3" aria-controls="expenseTable"
                                                        rowspan="1" colspan="1"
                                                        aria-label="지출: 지출한 금액">
                                                        지출
                                                    </th>
                                                    <th class="sorting" tabindex="4" aria-controls="expenseTable"
                                                        rowspan="1" colspan="1"
                                                        aria-label="수입: 수입 금액">
                                                        수입
                                                    </th>
                                                    <th class="sorting" tabindex="5" aria-controls="expenseTable"
                                                        rowspan="1" colspan="1"
                                                        aria-label="버튼: 수정/삭제">
                                                        수정/삭제
                                                    </th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="row">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <!-- /.content-wrapper -->

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
        <div class="p-3">
            <h5>Title</h5>
            <p>Sidebar content</p>
        </div>
    </aside>
    <!-- /.control-sidebar -->

    <!-- Main Footer -->
    <footer class="main-footer">
        <!-- To the right -->
        <div class="float-right d-none d-sm-inline">
            by jinnyjinnyjinjin
        </div>
        <!-- Default to the left -->
        <strong>Copyright &copy; 2014-2021 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved.
    </footer>
</div>
<!-- Modal -->
<div class="modal fade" id="minusFormModal" tabindex="-1" role="dialog" aria-labelledby="minusFormModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="minusFormModalLabel">지출 내용</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group row">
                        <label for="expenseDate" class="col-sm-2 col-form-label">지출 일시</label>
                        <div class="col-sm-10">
                            <div class="input-group date" data-target-input="nearest">
                                <input id=expenseDate type="text"
                                       class="input-group-append form-control datetimepicker-input date-format"
                                       data-target="#expenseDate">
                                <div class="input-group-append" data-target="#expenseDate"
                                     data-toggle="datetimepicker">
                                    <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="expenseDescription" class="col-sm-2 col-form-label">사용처</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="expenseDescription">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="amount" class="col-sm-2 col-form-label">금액</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control currency-input" id="amount">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                <button id="addExpense" type="button" class="btn btn-primary">등록</button>
            </div>
        </div>
    </div>
</div>

<!-- Income Modal -->
<div class="modal fade" id="incomeFormModal" tabindex="-1" role="dialog" aria-labelledby="incomeFormModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="incomeFormModalLabel">수입 내용</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group row">
                        <label for="incomeDate" class="col-sm-2 col-form-label">수입 일시</label>
                        <div class="col-sm-10">
                            <div class="input-group date" data-target-input="nearest">
                                <input id=incomeDate type="text"
                                       class="input-group-append form-control datetimepicker-input date-format"
                                       data-target="#incomeDate">
                                <div class="input-group-append" data-target="#incomeDate"
                                     data-toggle="datetimepicker">
                                    <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="incomeDescription" class="col-sm-2 col-form-label">내용</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="incomeDescription">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="incomeAmount" class="col-sm-2 col-form-label">금액</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control currency-input" id="incomeAmount">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                <button id="addIncome" type="button" class="btn btn-primary">등록</button>
            </div>
        </div>
    </div>
</div>

<!-- 수정 Modal -->
<div class="modal fade" id="editFormModal" tabindex="-1" role="dialog" aria-labelledby="editFormModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editFormModalLabel">수정 내용</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" id="editId">
                    <div class="form-group row">
                        <label for="editDate" class="col-sm-2 col-form-label">일시</label>
                        <div class="col-sm-10">
                            <div class="input-group date" data-target-input="nearest">
                                <input id=editDate type="text"
                                       class="input-group-append form-control datetimepicker-input date-format"
                                       data-target="#editDate">
                                <div class="input-group-append" data-target="#editDate"
                                     data-toggle="datetimepicker">
                                    <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="editDescription" class="col-sm-2 col-form-label">내용</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="editDescription">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="editSpentAmount" class="col-sm-2 col-form-label">수입 금액</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control currency-input" id="editSpentAmount">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="editIncomeAmount" class="col-sm-2 col-form-label">지출 금액</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control currency-input" id="editIncomeAmount">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                <button id="edit" type="button" class="btn btn-primary">수정</button>
            </div>
        </div>
    </div>
</div>
<!-- ./wrapper -->

<!-- REQUIRED SCRIPTS -->
<script src="/dist/js/expense/expensed.js"></script>
<!-- jQuery -->
<script src="/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/plugins/moment/moment.min.js"></script>
<script src="/plugins/daterangepicker/daterangepicker.js"></script>
<script src="/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
<script src="/dist/js/adminlte.min.js"></script>
<script src="/dist/js/custom/datepicker/global-datepicker.js"></script>
<!-- Datatables -->
<script src="/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>

<script>

    document.addEventListener('DOMContentLoaded', function () {

        initializeSearchDate();

        let expenseTable = $('#expenseTable').DataTable({
            paging: true,
            lengthChange: false,
            searching: false,
            ordering: true,
            info: true,
            autoWidth: false,
            responsive: true,
            order: [1, "desc"],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Korean.json',
                decimal: ','
            },
            ajax: {
                url: encodeURI('/api/v1/expenses'),
                method: 'GET',
                dataSrc: data => {
                    $('#totalExpense').text(numberWithCommas(data.data.totalSpent));
                    $('#totalIncome').text(numberWithCommas(data.data.totalIncome));
                    return data.data.expenses;
                }
            },
            columns: [
                {data: 'id'},
                {data: 'spentDate'},
                {data: 'description'},
                {
                    data: 'spent', render: function (data) {
                        return numberWithCommas(data);
                    }
                },
                {
                    data: 'income', render: function (data) {
                        return numberWithCommas(data);
                    }
                },
                {
                    data: null, render: function () {
                        return '<button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#editFormModal">수정</i></button> ' +
                            '<button id="deleteButton" type="button" class="btn btn-sm btn-danger">삭제</i></button> ';
                    }
                }
            ]
        });

        expenseTable.on('click', 'tbody tr', function () {
            const data = expenseTable.row(this).data();
            $('#editFormModal').on('show.bs.modal', function () {
                $('#editId').val(data.id);
                $('#editDate').val(data.spentDate);
                $('#editDescription').val(data.description);
                $('#editIncomeAmount').val(numberWithCommas(data.income));
                $('#editSpentAmount').val(numberWithCommas(data.spent));
            });
            $('#editFormModal').on('hidden.bs.modal', function () {
                $('#editId').val(data.id);
                $('#editDate').val(data.spentDate);
                $('#editDescription').val(data.description);
                $('#editIncomeAmount').val(numberWithCommas(data.income));
                $('#editSpentAmount').val(numberWithCommas(data.spent));
            });
        });

        expenseTable.on('click', '#deleteButton', function () {
            const data = expenseTable.row($(this).parents('tr')).data();
            const id = data.id;
            let going = confirm('삭제하시겠습니까?');
            if (!going) {
                return;
            }
            deleteOne(id);
        });

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        $('input.currency-input').on('keyup', function () {
            $(this).val(function (index, value) {
                return value.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            });
        });


        $('#addExpense').on('click', function () {
            let data = getExpenseData();
            sendPost(JSON.stringify(data));
        });

        $('#addIncome').on('click', function () {
            let data = getIncomeData();
            sendPost(JSON.stringify(data));
        });

        $('#edit').on('click', function () {
            let data = getEditData();
            sendPut($('#editId').val(), JSON.stringify(data));
        });

        function getExpenseData() {
            const date = document.querySelector('#expenseDate').value;
            const description = document.querySelector('#expenseDescription').value;
            const amount = document.querySelector('#amount').value;
            let number = amount.replaceAll(',', '');
            return {
                spentDate: date,
                description: description,
                spent: number
            }
        }

        function getIncomeData() {
            const date = document.querySelector('#incomeDate').value;
            const description = document.querySelector('#incomeDescription').value;
            const amount = document.querySelector('#incomeAmount').value;
            let number = amount.replaceAll(',', '');
            return {
                spentDate: date,
                description: description,
                income: number
            }
        }

        function getEditData() {
            const date = document.querySelector('#editDate').value;
            const description = document.querySelector('#editDescription').value;
            const incomeAmount = document.querySelector('#editIncomeAmount').value;
            const spentAmount = document.querySelector('#editSpentAmount').value;
            let spentNumber = spentAmount.replaceAll(',', '');
            let incomeNumber = incomeAmount.replaceAll(',', '');
            return {
                spent: spentNumber,
                spentDate: date,
                description: description,
                income: incomeNumber
            }
        }

        function sendPost(data) {
            $.ajax({
                method: 'POST',
                url: encodeURI('/api/v1/expenses'),
                accept: "application/json",
                contentType: "application/json",
                data: data
            }).done(function () {
                $('#minusFormModal').modal('hide');
                expenseTable.ajax.reload();
            }).fail(function (err) {
                alert('등록 실패 e: ' + err)
                console.error(err);
            });
        }

        function deleteOne(id) {
            $.ajax({
                method: 'DELETE',
                url: encodeURI('/api/v1/expenses/' + id),
            }).done(function () {
                expenseTable.ajax.reload();
            }).fail(function (err) {
                alert('삭제 실패 e: ' + err);
                console.error(err);
            });
        }

        function sendPut(id, data) {
            $.ajax({
                method: 'PUT',
                url: encodeURI('/api/v1/expenses/' + id),
                accept: "application/json",
                contentType: "application/json",
                data: data
            }).done(function () {
                $('#editFormModal').modal('hide');
                location.reload();
            }).fail(function (err) {
                console.error(err);
            });
        }

        $('#minusFormModal').on('hidden.bs.modal', function () {
            $('#expenseDate').val('');
            $('#expenseDescription').val('');
            $('#amount').val('');
        });

        $('#incomeFormModal').on('hidden.bs.modal', function () {
            $('#incomeDate').val('');
            $('#incomeDescription').val('');
            $('#incomeAmount').val('');
        });

        $('#searchItem').on('click', function () {

            let period = $('#expensePeriod').val();

            let split;
            let startDate = '';
            let endDate = '';
            if (period !== '') {
                split = period.split('~');
                startDate = split[0] ? split[0] : '';
                endDate = split[split.length - 1] ? split[split.length - 1] : '';
            }

            let url = '/api/v1/expenses?startDate=' + startDate + '&endDate=' + endDate;
            let encodedUrl = encodeURI(url);
            expenseTable.ajax.url(encodedUrl).load();
        });

    });

    function initializeSearchDate() {
        let date = new Date();
        let year = date.getFullYear();
        let month = date.getMonth() + 1;

        if (month < 10) {
            month = '0' + month;
        }
        const lastDate = new Date(year, month, 0).getDate();

        $('#expensePeriod').val(year + '-' + month + '-' + '01' + '~' + year + '-' + month + '-' + lastDate);
    }

</script>

</body>
</html>
